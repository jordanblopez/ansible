---
- hosts: web
  vars:
    db_password: password
    server_name: curriculum
    service_name: curriculum
    service_version: 1.0
    app_key: QujjaJs3fxwtnTl7FiqhEEn1ACkf7YZW
    app_env: test
    db_host: localhost
    db_database: curriculum
    db_username: curriculum
    db_port: 3306
    service_dir: /usr/share/nginx/{{ service_name }}
  tasks:
  - name: "Change SELinux to permissive"
    become: yes
    lineinfile: dest=/etc/sysconfig/selinux regexp='^SELINUX=' line='SELINUX=permissive'
 
  - name: "Again change SELinuz to permissive"
    become: yes
    command: setenforce 0

  - name: "Install the epel repo"
    become: yes
    yum: name=epel-release update_cache=yes state=present

  - name: Install nginx, php and related packages 
    become: yes
    yum: name=nginx,php,php-fpm,php-ldap,php-mbstring,php-mcrypt,php-mysql,php-phpunit-PHPUnit update_cache=yes state=present
    register: nginx_install

  - name: "Download and install Composer a Dependency Manager for PHP" 
    become: yes
    shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  - name: "Copy the nginx config file to the proper place"
    copy: src=web/nginx.conf dest=/etc/nginx/nginx.conf mode=0644
    become: true
    register: nginx_conf

  - name: "1 "
    become: yes
    template: src=web/vhost.conf.j2 dest=/etc/nginx/conf.d/{{ service_name }}.conf mode=0644
    register: vhost_conf
 
  - name: "2 "
    become: yes
    template: src=web/php.ini.j2 dest=/etc/php.ini mode=0644
    register: php_conf

  - name: "3 "
    become: yes
    copy: src=web/php-fpm-web.conf dest=/etc/php-fpm.d/www.conf mode=0644
    register: php_fpm_conf

  - name: "Restart nginx if changes were made to nginx related files"
    become: yes
    service: name=nginx state=restarted enabled=yes #changed from systemd to service due to version issues
    when: nginx_install|changed or nginx_conf|changed or vhost_conf|changed

  - name: "Restart php when there are changes made to the files"
    become: yes
    service: name=php-fpm state=restarted enabled=yes
    when: nginx_install|changed or php_conf|changed or php_fpm_conf|changed

  - name: "4 "
    become: yes
    file: path={{ service_dir }} state=absent

  - name: "4a" 
    become: yes
    file: path={{ service_dir }} state=directory
 
  - name: "5 "
    become: yes
    unarchive: src=web/{{ service_name }}.tgz dest={{ service_dir }} mode=0755
 
  - name: "6 "
    become: yes
    command: /usr/local/bin/composer update chdir={{ service_dir }}
  
  - name: "7 "
    become: yes
    command: chmod -R 0777 storage chdir={{ service_dir }}

  - name: "8 "
    become: yes
    command: chown nginx:nginx "{{ service_dir }}" -R
 
  - name: "9 "
    become: yes
    template: src=web/env.j2 dest="{{ service_dir }}/.env" mode=0644 owner=nginx

